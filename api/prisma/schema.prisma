generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  ADMIN
}

enum ShareAccessLevel {
  VIEW
  EDIT
}

enum CollaboratorPermission {
  VIEW
  EDIT
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  displayName  String
  role         UserRole @default(USER)
  preferences  Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  playlists     Playlist[]
  history       ListeningHistory[]
  likes         Like[]
  collaborations PlaylistCollaborator[]

  @@index([createdAt])
}

model Artist {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())

  albums Album[]
  tracks Track[]

  @@index([name])
}

model Album {
  id        String   @id @default(uuid())
  title     String
  coverUrl  String?
  artistId  String
  createdAt DateTime @default(now())

  artist Artist @relation(fields: [artistId], references: [id], onDelete: Restrict)
  tracks Track[]

  @@unique([artistId, title])
  @@index([artistId])
}

model AudioAsset {
  id         String   @id @default(uuid())
  storageKey String   @unique
  mimeType   String
  sizeBytes  BigInt
  checksum   String?
  createdAt  DateTime @default(now())

  tracks Track[]

  @@index([storageKey])
}

model Track {
  id              String   @id @default(uuid())
  title           String
  durationSeconds Int
  genre           String
  tags            String[] @default([])
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())

  artistId    String
  albumId     String?
  audioAssetId String

  artist    Artist    @relation(fields: [artistId], references: [id], onDelete: Restrict)
  album     Album?    @relation(fields: [albumId], references: [id], onDelete: SetNull)
  audioAsset AudioAsset @relation(fields: [audioAssetId], references: [id], onDelete: Restrict)

  playlistItems PlaylistItem[]
  history       ListeningHistory[]
  likes         Like[]

  @@index([artistId])
  @@index([albumId])
  @@index([genre])
  @@index([createdAt])
}

model Playlist {
  id        String   @id @default(uuid())
  ownerId   String
  name      String
  isPublic  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  items         PlaylistItem[]
  shares        PlaylistShare[]
  collaborators PlaylistCollaborator[]

  @@index([ownerId])
  @@index([createdAt])
  // optional: @@unique([ownerId, name])  // enable if you want playlist name unique per user
}

model PlaylistItem {
  id         String   @id @default(uuid())
  playlistId String
  trackId    String
  position   Int
  addedAt    DateTime @default(now())

  playlist Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  track    Track    @relation(fields: [trackId], references: [id], onDelete: Restrict)

  @@index([playlistId])
  @@index([playlistId, position])
  @@index([playlistId, trackId])

  @@unique([playlistId, position])
  @@unique([playlistId, trackId]) // remove if you want duplicates in playlists
}

model ListeningHistory {
  id                String   @id @default(uuid())
  userId            String
  trackId           String
  playedAt          DateTime @default(now())
  secondsPlayed     Int
  lastPositionSeconds Int?

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  track Track @relation(fields: [trackId], references: [id], onDelete: Restrict)

  @@index([userId, playedAt])
  @@index([trackId, playedAt])
}

model Like {
  id        String   @id @default(uuid())
  userId    String
  trackId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  track Track @relation(fields: [trackId], references: [id], onDelete: Restrict)

  @@unique([userId, trackId])
  @@index([userId])
  @@index([trackId])
}

model PlaylistShare {
  id          String          @id @default(uuid())
  playlistId  String
  token       String          @unique
  accessLevel ShareAccessLevel @default(VIEW)
  createdAt   DateTime        @default(now())
  expiresAt   DateTime?
  revokedAt   DateTime?

  playlist Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)

  @@index([playlistId])
  @@index([token])
}

model PlaylistCollaborator {
  id         String                  @id @default(uuid())
  playlistId String
  userId     String
  permission CollaboratorPermission  @default(VIEW)
  createdAt  DateTime                @default(now())

  playlist Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([playlistId, userId])
  @@index([playlistId])
  @@index([userId])
}
